name: Merge Game Mappings and Programs

on:
  push:
    branches:
      - main
    paths:
      - 'games/**/*.json'
      - 'programs/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge-mappings:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Merge game mappings and programs
        run: |
          # Create merge script for games
          cat > merge-games.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const gamesDir = path.join(__dirname, 'games');
          const outputFile = path.join(__dirname, 'mappings.json');
          const indexFile = path.join(__dirname, 'index.json');

          // Read all JSON files from games/ directory
          const gameFiles = fs.readdirSync(gamesDir)
            .filter(file => file.endsWith('.json'))
            .sort();

          const mappings = [];

          for (const file of gameFiles) {
            const filePath = path.join(gamesDir, file);
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              const mapping = JSON.parse(content);

              // Validate required fields
              if (!mapping.processName || !mapping.twitchCategoryId || !mapping.twitchCategoryName) {
                console.error(`âŒ Invalid mapping in ${file}: missing required fields`);
                process.exit(1);
              }

              // Ensure source field exists
              if (!mapping.source) {
                mapping.source = 'community';
              }

              mappings.push(mapping);
              console.log(`âœ… Loaded ${file}: ${mapping.processName} â†’ ${mapping.twitchCategoryName}`);
            } catch (error) {
              console.error(`âŒ Error reading ${file}:`, error.message);
              process.exit(1);
            }
          }

          // Sort by processName (case-insensitive)
          mappings.sort((a, b) =>
            a.processName.toLowerCase().localeCompare(b.processName.toLowerCase())
          );

          // Create final structure
          const output = {
            mappings: mappings
          };

          // Write to mappings.json
          fs.writeFileSync(outputFile, JSON.stringify(output, null, 2) + '\n', 'utf8');

          // Write to index.json
          let existingIndex = { formatVersion: '1' };
          if (fs.existsSync(indexFile)) {
            try {
              existingIndex = JSON.parse(fs.readFileSync(indexFile, 'utf8'));
            } catch (error) {
              console.warn('âš ï¸ Could not read existing index.json, using defaults');
            }
          }

          const indexData = {
            lastUpdate: Date.now(),
            formatVersion: existingIndex.formatVersion || '1'
          };
          fs.writeFileSync(indexFile, JSON.stringify(indexData, null, 2) + '\n', 'utf8');

          console.log(`\nðŸŽ‰ Successfully merged ${mappings.length} game mappings into mappings.json`);
          console.log(`ðŸ“‹ Updated index.json with timestamp: ${new Date(indexData.lastUpdate).toISOString()}`);
          EOF

          # Create merge script for programs
          cat > merge-programs.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const programsDir = path.join(__dirname, 'programs');
          const outputFile = path.join(__dirname, 'programs.json');

          // Read all JSON files from programs/ directory
          const programFiles = fs.readdirSync(programsDir)
            .filter(file => file.endsWith('.json'))
            .sort();

          const programs = [];

          for (const file of programFiles) {
            const filePath = path.join(programsDir, file);
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              const program = JSON.parse(content);

              // Validate required fields
              if (!program.processName || !program.twitchCategoryId || !program.twitchCategoryName) {
                console.error(`âŒ Invalid program in ${file}: missing required fields`);
                process.exit(1);
              }

              // Validate IGNORE category
              if (program.twitchCategoryId !== 'IGNORE') {
                console.error(`âŒ Invalid program in ${file}: twitchCategoryId must be "IGNORE"`);
                process.exit(1);
              }

              // Validate category field
              if (!program.category) {
                console.error(`âŒ Invalid program in ${file}: missing category field`);
                process.exit(1);
              }

              programs.push(program);
              console.log(`âœ… Loaded ${file}: ${program.processName} (${program.category})`);
            } catch (error) {
              console.error(`âŒ Error reading ${file}:`, error.message);
              process.exit(1);
            }
          }

          // Sort by processName (case-insensitive)
          programs.sort((a, b) =>
            a.processName.toLowerCase().localeCompare(b.processName.toLowerCase())
          );

          // Create final structure
          const output = {
            programs: programs
          };

          // Write to programs.json
          fs.writeFileSync(outputFile, JSON.stringify(output, null, 2) + '\n', 'utf8');

          console.log(`\nðŸŽ‰ Successfully merged ${programs.length} programs into programs.json`);
          EOF

          # Run merge scripts
          echo "ðŸ“¦ Merging game mappings..."
          node merge-games.js

          echo ""
          echo "ðŸ“¦ Merging programs..."
          node merge-programs.js

          # Check if mappings.json, programs.json, or index.json changed
          if git diff --quiet mappings.json programs.json index.json; then
            echo "No changes to mappings.json, programs.json, or index.json"
            echo "changed=false" >> $GITHUB_ENV
          else
            echo "mappings.json, programs.json, and/or index.json has been updated"
            echo "changed=true" >> $GITHUB_ENV
          fi

      - name: Commit and push if changed
        if: env.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add mappings.json programs.json index.json
          git commit -m "chore: regenerate mappings.json and programs.json

          ðŸ¤– Auto-generated by merge-mappings workflow from games/ and programs/ directories"
          git push

      - name: Summary
        run: |
          echo "## Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total game files:** $(ls -1 games/*.json 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total program files:** $(ls -1 programs/*.json 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes:** ${{ env.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.changed }}" == "true" ]; then
            echo "âœ… mappings.json, programs.json, and index.json have been regenerated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes detected in mappings.json, programs.json, or index.json" >> $GITHUB_STEP_SUMMARY
          fi
